<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>example websocket chat</title>
</head>

<body>
    <h1>websocket chat</h1>
    <div>
        <input id="room" type="text" placeholder="defalut" />
        <button id="join">join</button>
        <button id="leave">leave</button>
    </div>
    <div>
        <input id="message" type="text" />
        <button id="send">Send Message</button>
    </div>
</body>
<script src="/socket.io/socket.io.js"></script>
<script type="application/javascript">
    'use strict'

    const socket = io();

    document.getElementById('join').onclick = e => {
        socket.emit('join', document.getElementById('room').value, joinCallBack);
        // socket.emit('connect'); 호출 불가능
    };

    document.getElementById('leave').onclick = e => {
        socket.emit('leave');
    };

    document.getElementById('send').onclick = e => {
        const $message = document.getElementById('message');

        socket.emit('message', $message.value);
        document.body.appendChild(getMessageTpl({
            sender: 'YOU',
            content: $message.value
        }))

        $message.value = '';
    };

    // socket이 연결되면 발생, 내가 따로 서버에서 호출 불가능
    socket.on('connect', () => {
        console.log(`Connected as ${socket.id}`);
        socket.emit('join', undefined, joinCallBack); // join defaults
    });

    socket.on('message', message => {
        document.body.appendChild(getMessageTpl(message));
    });

    function getMessageTpl(data) {
        const $p = document.createElement('p');
        $p.appendChild(document.createTextNode(`${data.sender}: ${data.content}`));
        return $p;
    }

    function joinCallBack(result) {
        if (result && result.success) {
            document.body.appendChild(getMessageTpl({
                sender: 'SYSTEM',
                content: result.message
            }));
        }
    }
</script>

</html>
